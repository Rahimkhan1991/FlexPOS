<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - POS System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2s+lHh1p7n5K24Jq4i+c6A5aJ6K6O4f3T2X6Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-bg: #f1f5f9;
      --sidebar-bg: #1e293b;
      --sidebar-text: #f8fafc;
      --accent-color: #4f46e5;
      --accent-hover: #4338ca;
      --panel-bg: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
    }
    * {
        box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: var(--primary-bg);
    }
    /* Sidebar */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar h2 {
      font-size: 1.5rem;
      padding: 1.5rem;
      margin: 0;
      text-align: center;
      border-bottom: 1px solid #334155;
    }
    .sidebar .nav-link {
      color: var(--sidebar-text);
      text-decoration: none;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid #334155;
      transition: background-color 0.2s;
    }
    .sidebar .nav-link:hover {
      background-color: #334155;
    }
    .sidebar .nav-link.active {
      background-color: var(--accent-color);
      font-weight: bold;
    }
    .sidebar .nav-link .icon {
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .header h1 {
        margin: 0;
        color: var(--text-primary);
        font-size: 2rem;
    }
    .welcome {
      font-size: 1.1rem;
      color: var(--text-secondary);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .card {
      background: var(--panel-bg);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      border: 1px solid var(--border-color);
    }
    .card .icon-wrapper {
        font-size: 1.8rem;
        padding: 1rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .card .details h3 {
      margin: 0;
      font-size: 1.8rem;
      color: var(--text-primary);
    }
    .card .details p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .card.sales .icon-wrapper { background-color: #e0f2f1; color: #00796b; }
    .card.orders .icon-wrapper { background-color: #e3f2fd; color: #1e88e5; }
    .card.items-sold .icon-wrapper { background-color: #fff3e0; color: #fb8c00; }
    .card.top-item .icon-wrapper { background-color: #f3e5f5; color: #8e24aa; }

    /* Chart Section */
    .chart-container {
        background: var(--panel-bg);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
    }
    .chart-container h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>POS System</h2>
    <a href="dashboard.html" class="nav-link active"><i class="fas fa-chart-line icon"></i> Dashboard</a>
    <a href="pos.html" class="nav-link"><i class="fas fa-cash-register icon"></i> POS Billing</a>
    <a href="admin.html" class="nav-link"><i class="fas fa-cogs icon"></i> Admin Panel</a>
    </aside>

  <main class="main-content">
    <header class="header">
      <h1>Dashboard</h1>
      <div class="welcome">
        Welcome, <strong id="user-role">Admin</strong>!
      </div>
    </header>

    <div class="stats-grid">
      <div class="card sales">
        <div class="icon-wrapper"><i class="fas fa-rupee-sign"></i></div>
        <div class="details">
          <h3 id="sales-today">₹0.00</h3>
          <p>Total Sales Today</p>
        </div>
      </div>
      <div class="card orders">
        <div class="icon-wrapper"><i class="fas fa-receipt"></i></div>
        <div class="details">
          <h3 id="order-count">0</h3>
          <p>Orders Today</p>
        </div>
      </div>
      <div class="card items-sold">
        <div class="icon-wrapper"><i class="fas fa-box"></i></div>
        <div class="details">
          <h3 id="items-sold-count">0</h3>
          <p>Items Sold Today</p>
        </div>
      </div>
      <div class="card top-item">
        <div class="icon-wrapper"><i class="fas fa-star"></i></div>
        <div class="details">
          <h3 id="top-item">-</h3>
          <p>Top Selling Item</p>
        </div>
      </div>
    </div>

    <div class="chart-container">
        <h2>Last 7 Days Sales</h2>
        <canvas id="salesChart"></canvas>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- DATA RETRIEVAL ---
      const orders = JSON.parse(localStorage.getItem('orders') || '[]');
      const todayStr = new Date().toISOString().split('T')[0];

      // --- CALCULATE TODAY'S STATS ---
      const todayOrders = orders.filter(o => o.date === todayStr);
      
      // Correctly calculate total sales from the final 'total' of each order
      const totalSales = todayOrders.reduce((sum, order) => sum + order.total, 0);
      const totalOrdersCount = todayOrders.length;
      
      const totalItemsSold = todayOrders.reduce((sum, order) => {
        return sum + order.items.reduce((itemSum, item) => itemSum + item.qty, 0);
      }, 0);

      const itemCounts = todayOrders.reduce((counts, order) => {
        order.items.forEach(item => {
          counts[item.name] = (counts[item.name] || 0) + item.qty;
        });
        return counts;
      }, {});

      const topItem = Object.entries(itemCounts).sort((a,b) => b[1] - a[1])[0]?.[0] || 'N/A';
      
      // --- UPDATE STAT CARDS ---
      document.getElementById('sales-today').textContent = `₹${totalSales.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      document.getElementById('order-count').textContent = totalOrdersCount;
      document.getElementById('items-sold-count').textContent = totalItemsSold;
      document.getElementById('top-item').textContent = topItem;
      document.getElementById('user-role').textContent = localStorage.getItem('loggedUser') || 'Admin';

      // --- SALES CHART LOGIC ---
      function getSalesForLast7Days() {
        const salesData = {};
        const labels = [];
        
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            labels.push(label);
            salesData[dateStr] = 0;
        }

        orders.forEach(order => {
            if (salesData.hasOwnProperty(order.date)) {
                salesData[order.date] += order.total;
            }
        });

        return {
            labels: labels,
            data: Object.values(salesData)
        };
      }
      
      const salesChartData = getSalesForLast7Days();
      const ctx = document.getElementById('salesChart').getContext('2d');
      const salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: salesChartData.labels,
          datasets: [{
            label: 'Total Sales (₹)',
            data: salesChartData.data,
            borderColor: 'rgba(79, 70, 229, 1)',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.3,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) { return '₹' + value.toLocaleString('en-IN'); }
              }
            }
          },
          plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `Sales: ₹${context.parsed.y.toLocaleString('en-IN')}`;
                    }
                }
            }
          }
        }
      });
    });
  </script>
</body>
</html>