<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receipt 80mm</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
    body { font-family: monospace; text-align: center; }
    .receipt { 
        display: inline-block; 
        text-align: left; 
        border: 1px dashed #000; 
        padding: 10px; 
        width: 280px; 
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 2px 0; }
    th { border-bottom: 1px dashed #000; }
    .right { text-align: right; }
    .center { text-align: center; }
    .qr { margin-top: 10px; text-align: center; }
    .footer { margin-top: 8px; font-size: 12px; text-align: center; }
    .logo { max-width: 200px; max-height: 80px; display: block; margin: 0 auto 5px; object-fit: contain; }
    .charges { display: flex; justify-content: space-between; font-size: 14px; }
    .separator { border-top: 1px dashed #000; margin: 5px 0; }
</style>
</head>
<body>

<div class="receipt" id="receipt">
    <img id="shopLogo" class="logo" src="" alt="Logo">
    <div class="center"><strong id="shopName">My Shop Name</strong></div>
    <div class="center" id="shopAddress">Jalan Merdeka No.21, Malang, Indonesia</div>
    <div class="center" id="shopPhone"></div>
    <hr>
    <div>Table: <span id="tableNo"></span></div>
    <div>Cashier: <span id="cashier"></span></div>
    <div>Date & Time: <span id="dateTime"></span></div>
    <div>Invoice No: <span id="receiptNo"></span></div>
    <hr>
    <table>
        <thead>
            <tr>
                <th style="text-align:left;">Item</th>
                <th class="center">Qty</th>
                <th class="right">Price</th>
                <th class="right">Total</th>
            </tr>
        </thead>
        <tbody id="receiptItems"></tbody>
    </table>
    <hr>
    <div class="charges"><span class="label">Subtotal:</span> <span class="amount" id="subTotal"></span></div>
    <div class="charges"><span class="label">Tax:</span> <span class="amount" id="tax"></span></div>
    <div class="charges"><span class="label">Service Charge:</span> <span class="amount" id="serviceCharge"></span></div>
    <div class="charges"><span class="label">Discount:</span> <span class="amount" id="discount"></span></div>
    <div class="separator"></div>
    <div class="charges"><strong class="label">Total:</strong> <strong class="amount" id="totalAmount"></strong></div>
    <div class="separator"></div>
    <div class="charges"><span class="label">Cash Received:</span> <span class="amount" id="cashReceived"></span></div>
    <div class="charges"><span class="label">Change:</span> <span class="amount" id="change"></span></div>
    <hr>
    <div class="center" id="footerText">Thank you for visiting!</div>
</div>

<div class="qr">
    <canvas id="qrcode"></canvas>
    <div id="qrAmount"></div>
    <div>Linked to QRIS (BRI)</div>
</div>

<div class="footer">
    Powered by MyShop Billing System
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Get Data from localStorage ---
        const orderData = JSON.parse(localStorage.getItem('currentPrintOrder')) || {};
        const shopName = localStorage.getItem('shopName') || 'My Shop Name';
        const shopAddress = localStorage.getItem('shopAddress') || 'Shop Address Here';
        const shopPhone = localStorage.getItem('shopPhone') || '';
        const footerText = localStorage.getItem('footerText') || 'Thank you for visiting!';
        const logoSrc = localStorage.getItem('shopLogo');

        // --- Populate Shop Info ---
        document.getElementById('shopName').innerText = shopName;
        document.getElementById('shopAddress').innerText = shopAddress;
        document.getElementById('shopPhone').innerText = shopPhone;
        document.getElementById('footerText').innerText = footerText;
        if (logoSrc) document.getElementById('shopLogo').src = logoSrc;

        // --- Populate Order Info ---
        document.getElementById('tableNo').innerText = orderData.table || 'N/A';
        document.getElementById('cashier').innerText = orderData.cashier || 'Cashier';
        document.getElementById('dateTime').innerText = `${orderData.date || ''} ${orderData.time || ''}`;
        document.getElementById('receiptNo').innerText = orderData.orderId || new Date().getTime();

        // --- Populate Items Table ---
        const receiptItems = document.getElementById('receiptItems');
        receiptItems.innerHTML = '';
        if (orderData.items && orderData.items.length > 0) {
            orderData.items.forEach(item => {
                // ✅ FIX: Use item.sales, not item.price
                const price = parseFloat(item.sales) || 0;
                const qty = item.qty || 0;
                const total = price * qty;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align:left;">${item.name}</td>
                    <td class="center">${qty}</td>
                    <td class="right">${price.toFixed(2)}</td>
                    <td class="right">${total.toFixed(2)}</td>
                `;
                receiptItems.appendChild(row);
            });
        }
        
        // --- Populate Totals ---
        // ✅ FIX: Use the totals directly from orderData, don't recalculate
        const subTotal = parseFloat(orderData.subtotal) || 0;
        const tax = parseFloat(orderData.tax) || 0;
        const serviceCharge = parseFloat(orderData.serviceCharge) || 0;
        const discount = parseFloat(orderData.discount) || 0; // Note: Discount value was already a number, not an object
        const totalAmount = parseFloat(orderData.total) || 0;

        document.getElementById('subTotal').innerText = subTotal.toFixed(2);
        document.getElementById('tax').innerText = tax.toFixed(2);
        document.getElementById('serviceCharge').innerText = serviceCharge.toFixed(2);
        document.getElementById('discount').innerText = `-${discount.toFixed(2)}`;
        document.getElementById('totalAmount').innerText = totalAmount.toFixed(2);

        // --- (QR Code and Printing Logic can remain the same if they were working) ---
        // Example for Cash Received & Change (can be improved)
        if (orderData.paymentMethod === 'Cash') {
            // This part is tricky without knowing the exact cash paid. 
            // We'll assume totalAmount for now if not provided.
            const cashReceived = totalAmount; 
            const change = cashReceived - totalAmount;
            document.getElementById('cashReceived').innerText = cashReceived.toFixed(2);
            document.getElementById('change').innerText = change.toFixed(2);
        } else {
            document.getElementById('cashReceived').closest('.charges').style.display = 'none';
            document.getElementById('change').closest('.charges').style.display = 'none';
        }
        
        // ⭐ NEW: Auto-print when the page loads
        window.print();
    });
</script>

</body>
</html>
