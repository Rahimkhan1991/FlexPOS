<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Receipt - 80mm</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            width: 283px;
            margin: 0 auto;
            color: #000;
        }
        .receipt-container { padding: 15px 10px; }
        .header { text-align: center; margin-bottom: 10px; }
        .logo { max-width: 150px; max-height: 80px; margin-bottom: 5px; }
        .shop-name { font-size: 16px; font-weight: bold; }
        .info { font-size: 12px; border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin-bottom: 10px; }
        .info-line { display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        thead th { border-bottom: 1px dashed #000; text-align: left; }
        th, td { padding: 2px 0; vertical-align: top; }
        .col-item { width: 45%; }
        .col-qty { width: 15%; text-align: center; }
        .col-price, .col-total { width: 20%; text-align: right; }
        .totals { margin-top: 10px; border-top: 1px dashed #000; padding-top: 5px; font-size: 13px; }
        .totals .line { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .grand-total { font-weight: bold; font-size: 16px; }
        .footer, .qr-section { margin-top: 10px; text-align: center; font-size: 12px; }
    </style>
</head>
<body>

<div class="receipt-container">
    <div class="header">
        <img id="logo" class="logo" alt="logo" style="display: none;">
        <div id="companyName" class="shop-name"></div>
        <div id="address"></div>
        <div id="phone"></div>
        <div id="email"></div>
    </div>

    <div class="info">
        <div class="info-line"><span>Invoice:</span><span id="receiptNo"></span></div>
        <div class="info-line"><span>Cashier:</span><span id="cashier"></span></div>
        <div class="info-line"><span>Date:</span><span id="date"></span></div>
        <div class="info-line"><span>Ref:</span><span id="table"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th class="col-item">Item</th>
                <th class="col-qty">Qty</th>
                <th class="col-price">Price</th>
                <th class="col-total">Total</th>
            </tr>
        </thead>
        <tbody id="items"></tbody>
    </table>

    <div class="totals">
        <div class="line"><span>Subtotal</span><span id="subtotal"></span></div>
        <div class="line"><span>Discount</span><span id="discount"></span></div>
        <div class="line" id="serviceChargeLine" style="display: none;"><span>Service</span><span id="serviceCharge"></span></div>
        <div class="line"><span>Tax</span><span id="tax"></span></div>
        <div class="line grand-total"><span>TOTAL</span><span id="total"></span></div>
        <div id="paymentDetails">
             <div class="line" style="border-top: 1px dashed #000; margin-top: 5px; padding-top: 5px;">
                 <span>Paid by</span><span id="paymentMethod"></span>
             </div>
             <div class="line" id="cashReceivedLine"><span>Cash</span><span id="cashReceived"></span></div>
             <div class="line" id="changeLine"><span>Change</span><span id="change"></span></div>
        </div>
    </div>

    <div class="qr-section">
        <canvas id="qrcode"></canvas>
        <div style="font-size: 10px;">Scan to Pay with QRIS</div>
    </div>

    <div class="footer">
        <p id="footerText"></p>
        <p>Thank you!</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Get data from localStorage
    const settings = JSON.parse(localStorage.getItem('systemSettings')) || {};
    const order = JSON.parse(localStorage.getItem('currentPrintOrder')) || {};

    const currency = settings.currency || 'Rp';

    // --- Populate Company Info ---
    if (settings.logo) {
        document.getElementById('logo').src = settings.logo;
        document.getElementById('logo').style.display = 'block';
    }
    document.getElementById('companyName').innerText = settings.companyName || 'My Restaurant';
    document.getElementById('address').innerText = settings.address || '';
    document.getElementById('phone').innerText = settings.phoneNumber || '';
    document.getElementById('email').innerText = settings.email || '';
    document.getElementById('footerText').innerText = settings.footerText || '';

    // --- Populate Order Info ---
    document.getElementById('receiptNo').innerText = order.orderId || new Date().getTime();
    document.getElementById('cashier').innerText = order.cashier || 'Admin';
    document.getElementById('date').innerText = `${order.date || ''} ${order.time || ''}`;
    document.getElementById('table').innerText = order.table || 'N/A';
    
    // --- Populate Items ---
    const itemsContainer = document.getElementById('items');
    itemsContainer.innerHTML = '';
    order.items?.forEach(item => {
        const itemTotal = (parseFloat(item.sales) * item.qty).toFixed(2);
        const price = parseFloat(item.sales).toFixed(2);
        const row = `<tr><td class="col-item">${item.name}</td><td class="col-qty">${item.qty}</td><td class="col-price">${price}</td><td class="col-total">${itemTotal}</td></tr>`;
        itemsContainer.innerHTML += row;
    });

    // --- Populate Totals ---
    document.getElementById('subtotal').innerText = `${currency} ${parseFloat(order.subtotal || 0).toFixed(2)}`;
    document.getElementById('discount').innerText = `- ${currency} ${parseFloat(order.discount || 0).toFixed(2)}`;
    document.getElementById('tax').innerText = `${currency} ${parseFloat(order.tax || 0).toFixed(2)}`;
    document.getElementById('total').innerText = `${currency} ${parseFloat(order.total || 0).toFixed(2)}`;
    
    const serviceCharge = parseFloat(order.serviceCharge || 0);
    if (serviceCharge > 0) {
        document.getElementById('serviceCharge').innerText = `${currency} ${serviceCharge.toFixed(2)}`;
        document.getElementById('serviceChargeLine').style.display = 'flex';
    }

    // --- Populate Payment Details ---
    document.getElementById('paymentMethod').innerText = order.paymentMethod || 'N/A';
    if (order.paymentMethod === 'Cash' && order.cashReceived) {
        document.getElementById('cashReceived').innerText = `${currency} ${parseFloat(order.cashReceived).toFixed(2)}`;
        document.getElementById('change').innerText = `${currency} ${parseFloat(order.change).toFixed(2)}`;
    } else {
        document.getElementById('cashReceivedLine').style.display = 'none';
        document.getElementById('changeLine').style.display = 'none';
    }

    // --- Generate QR Code ---
    const totalAmount = parseFloat(order.total || 0).toFixed(2);
    // This is a standard format for some payment gateways, you might need to adjust it.
    // Example: 00020126... followed by merchant info and amount.
    // For simplicity, we'll just encode the total amount.
    const qrData = `Total: ${currency} ${totalAmount}`;
    QRCode.toCanvas(document.getElementById('qrcode'), qrData, { width: 120, margin: 1 }, function (error) {
        if (error) console.error(error);
    });

    // --- Auto Print ---
    setTimeout(() => { window.print(); }, 500);
    window.onafterprint = () => window.close();
});
</script>

</body>
</html>