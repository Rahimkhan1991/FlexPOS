<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Reports</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
  </style>
</head>
<body class="bg-slate-100">

<!-- Header -->
<header class="bg-white shadow-sm border-b border-slate-200">
  <div class="max-w-6xl mx-auto py-4 px-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-slate-800">Sales Reports</h1>
    <button onclick="window.location.href='reports.html'" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded">
      <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
    </button>
  </div>
</header>

<main class="max-w-6xl mx-auto py-6 px-4">

  <!-- Filters + Export -->
  <div class="bg-white p-4 rounded-lg shadow-sm flex flex-wrap gap-4 mb-6 items-end border border-slate-200">
    <div>
      <label class="text-sm text-slate-600">Start Date</label>
      <input type="date" id="startDate" class="border rounded px-2 py-1 text-sm">
    </div>
    <div>
      <label class="text-sm text-slate-600">End Date</label>
      <input type="date" id="endDate" class="border rounded px-2 py-1 text-sm">
    </div>
    <button id="filterBtn" class="bg-indigo-600 text-white px-4 rounded h-9 text-sm">Filter</button>
    <button id="resetFilterBtn" class="bg-gray-400 text-white px-4 rounded h-9 text-sm">Reset</button>

    <div class="ml-auto flex gap-2">
      <button id="exportCsvBtn" class="bg-green-600 text-white px-3 rounded h-9 text-sm"><i class="fas fa-file-csv mr-1"></i> CSV</button>
      <button id="exportPdfBtn" class="bg-red-600 text-white px-3 rounded h-9 text-sm"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

  <!-- Top Items -->
  <div id="topItems" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-8">
    <h3 class="font-semibold text-slate-800 mb-2">Top Selling Items</h3>
    <ul id="topItemsList" class="text-slate-700 text-sm list-disc pl-5"></ul>
  </div>

  <!-- Bill History -->
  <div id="billHistory" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
    <div class="p-4 border-b border-slate-200">
      <h2 class="text-lg font-semibold text-slate-800">Bill History</h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-6 py-3 text-left font-medium">Order ID</th>
            <th class="px-6 py-3 text-left font-medium">Date</th>
            <th class="px-6 py-3 text-left font-medium">Type</th>
            <th class="px-6 py-3 text-left font-medium">Payment</th>
            <th class="px-6 py-3 text-right font-medium">Total</th>
          </tr>
        </thead>
        <tbody id="historyTableBody" class="bg-white divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>

</main>

<!-- Bill Details Popup -->
<div id="billDetailPopup" class="fixed inset-0 bg-slate-900 bg-opacity-60 hidden items-center justify-center z-20">
  <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
    <div class="mb-4 border-b pb-3">
      <h2 class="text-lg font-semibold text-slate-800">Invoice Details</h2>
      <p id="billDetailOrderId" class="text-sm text-slate-500"></p>
    </div>
    <div id="billDetailContent" class="text-sm text-slate-700 max-h-96 overflow-y-auto custom-scrollbar"></div>
    <div class="flex justify-between gap-4 mt-6 pt-4 border-t">
      <button id="closePopupBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 text-sm font-medium py-2 px-4 rounded w-full">Close</button>
      <button id="reprintBtn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded w-full">
        <i class="fas fa-print mr-2"></i>Reprint
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const sales = JSON.parse(localStorage.getItem('sales')) || [];
  let filteredSales = [...sales];

  const summaryCardsContainer = document.getElementById('summaryCards');
  const tableBody = document.getElementById('historyTableBody');
  const topItemsList = document.getElementById('topItemsList');
  const billDetailPopup = document.getElementById('billDetailPopup');
  const billDetailContent = document.getElementById('billDetailContent');
  const billDetailOrderId = document.getElementById('billDetailOrderId');
  const reprintBtn = document.getElementById('reprintBtn');
  const closePopupBtn = document.getElementById('closePopupBtn');

  const formatCurrency = amt => new Intl.NumberFormat('en-IN',{style:'currency',currency:'INR'}).format(amt);
  const formatDateTime = iso => new Date(iso).toLocaleString();

  // --- Filter ---
  document.getElementById('filterBtn').addEventListener('click', () => {
    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;

    if (!startInput) {
      alert("Please select a date");
      return;
    }

    const startDate = new Date(startInput);
    const endDate = endInput ? new Date(endInput) : new Date(startInput);

    startDate.setHours(0,0,0,0);
    endDate.setHours(23,59,59,999);

    filteredSales = sales.filter(sale => {
      const saleDate = new Date(sale.date);
      return saleDate >= startDate && saleDate <= endDate;
    });

    renderDashboard();
  });

  // --- Reset Filter ---
  document.getElementById('resetFilterBtn').addEventListener('click', () => {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    filteredSales = [...sales];
    renderDashboard();
  });

  // --- Export CSV ---
  document.getElementById('exportCsvBtn').addEventListener('click', () => {
    let csv = "Order ID,Date,Type,Payment,Total\n";
    filteredSales.forEach(s => {
      csv += `${s.orderId},${formatDateTime(s.date)},${s.orderType},${s.paymentMethod},${s.total}\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'sales-report.csv'; a.click();
  });

  // --- Export PDF ---
  document.getElementById('exportPdfBtn').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    doc.setFontSize(16);
    doc.text("Sales Report", 105, 20, { align: "center" });

    const startInput = document.getElementById('startDate').value;
    const endInput = document.getElementById('endDate').value;
    let rangeText = "All Dates";
    if (startInput) {
      rangeText = endInput ? `${startInput} to ${endInput}` : startInput;
    }
    doc.setFontSize(11);
    doc.text(`Date Range: ${rangeText}`, 105, 28, { align: "center" });

    let y = 40;
    doc.setFontSize(12);
    doc.text("Invoice", 14, y);
    doc.text("Date", 50, y);
    doc.text("Type", 100, y);
    doc.text("Payment", 140, y);
    doc.text("Total", 195, y, { align: "right" });

    doc.line(14, y+2, 200, y+2);
    y += 10;

    filteredSales.forEach(s => {
      doc.setFontSize(10);
      doc.text(s.orderId.toString(), 14, y);
      doc.text(formatDateTime(s.date), 50, y);
      doc.text(s.orderType || "N/A", 100, y);
      doc.text(s.paymentMethod || "N/A", 140, y);
      doc.text(formatCurrency(s.total), 195, y, { align: "right" });
      y += 7;
      if (y > 270) { doc.addPage(); y = 20; }
    });

    const totalRevenue = filteredSales.reduce((sum, s) => sum + s.total, 0);
    const totalOrders = filteredSales.length;
    const avgOrder = totalOrders > 0 ? totalRevenue / totalOrders : 0;

    y += 15;
    if (y > 250) { doc.addPage(); y = 20; }

    doc.setFontSize(13);
    doc.text("Summary", 14, y);
    y += 8;
    doc.setFontSize(11);
    doc.text(`Total Orders: ${totalOrders}`, 14, y);
    y += 6;
    doc.text(`Total Revenue: ${formatCurrency(totalRevenue)}`, 14, y);
    y += 6;
    doc.text(`Average Order Value: ${formatCurrency(avgOrder)}`, 14, y);

    doc.save("sales-report.pdf");
  });

  // --- Dashboard Rendering ---
  function renderDashboard() {
    renderSummary();
    renderHistory();
    renderTopItems();
  }

  function renderSummary() {
    const revenue = filteredSales.reduce((s, x) => s + x.total, 0);
    const orders = filteredSales.length;
    const profit = filteredSales.reduce((p, s) => {
      const cost = s.items.reduce((c,i)=>c+(i.purchase||0)*i.qty,0);
      return p + (s.total - cost);
    },0);

    summaryCardsContainer.innerHTML = `
      <div class="bg-white p-4 rounded-lg border border-slate-200">
        <p class="text-xs text-slate-500">Revenue</p>
        <p class="text-xl font-semibold">${formatCurrency(revenue)}</p>
      </div>
      <div class="bg-white p-4 rounded-lg border border-slate-200">
        <p class="text-xs text-slate-500">Profit</p>
        <p class="text-xl font-semibold">${formatCurrency(profit)}</p>
      </div>
      <div class="bg-white p-4 rounded-lg border border-slate-200">
        <p class="text-xs text-slate-500">Orders</p>
        <p class="text-xl font-semibold">${orders}</p>
      </div>`;
  }

  function renderHistory() {
    tableBody.innerHTML = '';
    if (filteredSales.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-500">No records found.</td></tr>`;
      return;
    }
    filteredSales.slice().reverse().forEach(s => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-slate-50 cursor-pointer';
      row.innerHTML = `
        <td class="px-6 py-3">${s.orderId}</td>
        <td class="px-6 py-3">${formatDateTime(s.date)}</td>
        <td class="px-6 py-3">${s.orderType || ''}</td>
        <td class="px-6 py-3">${s.paymentMethod}</td>
        <td class="px-6 py-3 text-right font-semibold">${formatCurrency(s.total)}</td>`;
      row.addEventListener('click', () => showBillDetails(s));
      tableBody.appendChild(row);
    });
  }

  function renderTopItems() {
    const counts = {};
    filteredSales.forEach(s => s.items.forEach(i => counts[i.name] = (counts[i.name]||0)+i.qty));
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
    topItemsList.innerHTML = sorted.map(([name,qty])=>`<li>${name} (${qty} sold)</li>`).join('');
  }

  // --- Bill Details ---
  function showBillDetails(sale) {
    billDetailOrderId.textContent = `Order ID: ${sale.orderId}`;
    let itemsHtml = sale.items.map(i => `
      <div class="flex justify-between py-1">
        <span>${i.name} (x${i.qty})</span>
        <span>${formatCurrency(i.sales * i.qty)}</span>
      </div>`).join('');
    billDetailContent.innerHTML = `
      <div class="font-medium mb-2">Items</div>${itemsHtml}
      <div class="border-t pt-2 mt-2">
        <div class="flex justify-between"><span>Subtotal:</span><span>${formatCurrency(sale.subtotal)}</span></div>
        <div class="flex justify-between"><span>Discount:</span><span>- ${formatCurrency(sale.discount)}</span></div>
        <div class="flex justify-between"><span>Tax:</span><span>${formatCurrency(sale.tax)}</span></div>
        <div class="flex justify-between font-semibold text-base mt-1"><span>Total:</span><span>${formatCurrency(sale.total)}</span></div>
      </div>`;
    reprintBtn.dataset.saleData = JSON.stringify(sale);
    billDetailPopup.style.display = 'flex';
  }

  function handleReprint() {
    const sale = JSON.parse(reprintBtn.dataset.saleData || "{}");
    if (!sale.orderId) return;
    const printData = {...sale, date: new Date(sale.date).toLocaleDateString(), time: new Date(sale.date).toLocaleTimeString()};
    localStorage.setItem('currentPrintOrder', JSON.stringify(printData));
    const printerSize = localStorage.getItem('printerSize') || '80';
    window.open(printerSize === '80' ? 'receipt-80mm.html' : 'receipt-57mm.html', '_blank');
  }

  closePopupBtn.addEventListener('click', () => billDetailPopup.style.display = 'none');
  reprintBtn.addEventListener('click', handleReprint);

  renderDashboard();
});
</script>

</body>
</html>
